<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…±åŒç§‘ç›®ï¼šç’°å¢ƒä¿è­·</title>
    <style>
        :root { --main: #0984e3; --bg: #f0f2f5; --win: #00b894; --lose: #d63031; }
        body { font-family: "Microsoft JhengHei", sans-serif; background: var(--bg); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        #game-box { background: white; width: 95%; max-width: 450px; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; }
        #timer-bg { width: 100%; height: 10px; background: #eee; border-radius: 5px; overflow: hidden; margin: 15px 0; }
        #timer-fill { width: 100%; height: 100%; background: #ff7675; transition: width 0.1s linear; }
        .q-text { font-size: 1.15em; font-weight: bold; margin-bottom: 20px; min-height: 60px; color: #2d3436; text-align: left; line-height: 1.4; }
        .options-grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
        .opt-btn { padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; background: white; cursor: pointer; font-size: 1.05em; text-align: left; outline: none; transition: 0.2s; }
        .opt-btn:hover:not(:disabled) { border-color: var(--main); background: #f1f9ff; }
        .correct { background: var(--win) !important; color: white; border-color: var(--win); }
        .wrong { background: var(--lose) !important; color: white; border-color: var(--lose); }
        .hidden { display: none; }
        .rule-box { background: #fff9db; border: 1px solid #ffe066; padding: 12px; border-radius: 10px; text-align: left; font-size: 0.9em; margin-bottom: 20px; color: #665c33; }
        select#player-no { width: 100%; padding: 10px; font-size: 1.1em; border-radius: 8px; border: 2px solid var(--main); margin-bottom: 20px; outline: none; }
        button#start-btn { padding: 12px 35px; font-size: 1.2em; background: var(--main); color: white; border: none; border-radius: 50px; cursor: pointer; transition: 0.3s; width: 100%; }
        button#start-btn:disabled { background: #ccc; cursor: not-allowed; }
        #debug-log { background: #222; color: #00ff00; padding: 10px; font-family: monospace; font-size: 11px; text-align: left; margin-top: 20px; border-radius: 5px; max-height: 80px; overflow-y: auto; word-break: break-all; }
        .rank-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #ddd; }
        .rank-name { font-weight: bold; }
        .rank-score { color: var(--main); font-weight: bold; }
    </style>
</head>
<body>

<div id="game-box">
    <!-- é–‹å§‹ç•«é¢ -->
    <div id="start-screen">
        <h2 style="color: var(--main); margin-bottom: 10px;">å…±åŒç§‘ç›®ï¼šç’°å¢ƒä¿è­·</h2>
        <div class="rule-box">
            <strong>ğŸ“ è¨ˆåˆ†è¦å‰‡èªªæ˜ï¼š</strong><br>
            1. æ¯æ¬¡æ¸¬é©—å°‡éš¨æ©ŸæŠ½å– <strong>10 é¡Œ</strong>ã€‚<br>
            2. æ¯é¡Œä½œç­”æ™‚é–“ç‚º <strong>30 ç§’</strong>ã€‚<br>
            3. ç­”å°åˆ†æ•¸ = åŸºç¤ 10 åˆ† + å‰©é¤˜ç§’æ•¸çå‹µã€‚<br>
            4. ç­”éŒ¯æˆ–é€¾æ™‚ä¸çµ¦åˆ†ã€‚
        </div>
        <p style="text-align: left; font-weight: bold; margin-bottom: 5px;">é¸æ“‡åº§è™Ÿï¼š</p>
        <select id="player-no"></select>
        <button id="start-btn" onclick="initGame()" disabled>é€£ç·šä¸­...</button>
        <div id="debug-log">ç³»çµ±ç‹€æ…‹ï¼šåˆå§‹åŒ–ä¸­...</div>
    </div>

    <!-- æ¸¬é©—å€åŸŸ -->
    <div id="quiz-area" class="hidden">
        <div style="display:flex; justify-content:space-between; font-weight:bold; color:var(--main); font-size: 0.9em;">
            <span id="q-count">0/10</span>
            <span id="score-text">å¾—åˆ†: 0</span>
        </div>
        <div id="timer-bg"><div id="timer-fill"></div></div>
        <div id="q-text" class="q-text"></div>
        <div class="options-grid" id="options-area">
            <button class="opt-btn" onclick="handleAnswer(1)"></button>
            <button class="opt-btn" onclick="handleAnswer(2)"></button>
            <button class="opt-btn" onclick="handleAnswer(3)"></button>
            <button class="opt-btn" onclick="handleAnswer(4)"></button>
        </div>
    </div>

    <!-- çµæŸç•«é¢ -->
    <div id="end-screen" class="hidden">
        <h3>æ¸¬é©—å®Œæˆ</h3>
        <h1 id="final-score" style="font-size: 3em; color: var(--main); margin: 10px 0;">0</h1>
        <div id="rank-box" style="margin-top:15px; text-align:left; background:#f9f9f9; padding:15px; border-radius:10px; font-size: 0.9em;">
            <div style="text-align:center; font-weight:bold; color: #555; margin-bottom: 8px;">ğŸ† ç’°å¢ƒä¿è­·å³æ™‚æ’è¡Œæ¦œ</div>
            <div id="rank-content">æ’è¡Œæ¦œè¼‰å…¥ä¸­...</div>
        </div>
        <button onclick="location.reload()" style="margin-top:20px; padding:10px 25px; border-radius:20px; border:none; background:var(--main); color:white; cursor:pointer; width: 100%;">é‡æ–°æ¸¬é©—</button>
    </div>
</div>

<script>
    // é…ç½®è³‡è¨Š
    const SHEET_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSlNoNC2mjqp1xTbd3cVb5fWVOjSbYXasb57gR5R_p85fFEO6nUxmc7IouYpq6OTfTxuC9x_Phs7Yja/pub?output=csv";
    const RANK_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQsjgmdj7BVDgzeqaJIJ9OA-XiFka3wLOTPxgT0xkgGY8gbIbUJS1glfVxox4rHk4xI1FmfLL4X_NvE/pub?output=csv";
    const FORM_BASE_URL = "https://docs.google.com/forms/d/e/1FAIpQLSeJOtNGnQHIM7_B6l6CRZHYuDRuoRsO4ilQKdAZI222YFPyog";
    const ID_NO = "entry.380705505";      
    const ID_SCORE = "entry.330260248";   

    let allQuestions = [], gameQuestions = [];
    let currentIdx = 0, score = 0, timer, timeLeft = 30, currentCorrectValue = 0;

    function log(txt) { 
        const lb = document.getElementById('debug-log');
        lb.innerHTML += "<br>> " + txt; 
        lb.scrollTop = lb.scrollHeight;
    }

    // åˆå§‹åŒ–åº§è™Ÿ
    const sel = document.getElementById('player-no');
    for(let i=1; i<=36; i++){
        let o = document.createElement('option'); 
        o.value = i; 
        o.textContent = i + " è™Ÿ";
        sel.appendChild(o);
    }

    // è®€å–é¡Œåº«
    async function loadData() {
        try {
            log("é€£ç·šé¡Œåº«ä¸­...");
            const res = await fetch(`${SHEET_CSV}&t=${Date.now()}`);
            if (!res.ok) throw new Error("é€£ç·šå¤±æ•—");
            const text = await res.text();
            
            const lines = text.split(/\r?\n/);
            const temp = [];
            lines.forEach((line) => {
                const cols = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.replace(/^"|"$/g, '').trim());
                if (cols.length >= 6 && ['1','2','3','4'].includes(cols[1])) {
                    temp.push({ 
                        q: cols[0], 
                        opts: [cols[2], cols[3], cols[4], cols[5]], 
                        a: parseInt(cols[1]) 
                    });
                }
            });

            if (temp.length > 0) {
                allQuestions = temp;
                document.getElementById('start-btn').disabled = false;
                document.getElementById('start-btn').innerText = "é–‹å§‹æ¸¬é©—";
                log("âœ… æˆåŠŸï¼å·²è®€å– " + allQuestions.length + " é¡Œã€‚");
            } else {
                log("âŒ é¡Œåº«æ ¼å¼éŒ¯èª¤ã€‚");
            }
        } catch (e) {
            log("âŒ è®€å–å¤±æ•—ã€‚");
        }
    }

    function initGame() {
        gameQuestions = [...allQuestions].sort(() => Math.random() - 0.5).slice(0, 10);
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('quiz-area').classList.remove('hidden');
        showQuestion();
    }

    function showQuestion() {
        if (currentIdx >= gameQuestions.length) { endGame(); return; }
        const data = gameQuestions[currentIdx];
        document.getElementById('q-count').innerText = `${currentIdx+1} / 10`;
        document.getElementById('q-text').innerText = (currentIdx+1) + ". " + data.q;
        currentCorrectValue = data.a;
        const btns = document.querySelectorAll('.opt-btn');
        btns.forEach((btn, i) => {
            btn.innerText = "(" + (i + 1) + ") " + data.opts[i];
            btn.className = 'opt-btn';
            btn.disabled = false;
        });
        startTimer();
    }

    function startTimer() {
        timeLeft = 30;
        clearInterval(timer);
        timer = setInterval(() => {
            timeLeft -= 0.1;
            document.getElementById('timer-fill').style.width = (timeLeft / 30) * 100 + "%";
            if (timeLeft <= 0) handleAnswer(-1); 
        }, 100);
    }

    function handleAnswer(val) {
        clearInterval(timer);
        const btns = document.querySelectorAll('.opt-btn');
        btns.forEach(b => b.disabled = true);
        
        if (val === currentCorrectValue) {
            btns[val-1].classList.add('correct');
            score += 10 + Math.max(0, Math.floor(timeLeft));
        } else {
            if (val !== -1 && btns[val-1]) btns[val-1].classList.add('wrong');
            btns[currentCorrectValue-1].classList.add('correct');
        }
        
        document.getElementById('score-text').innerText = "å¾—åˆ†: " + score;
        setTimeout(() => { currentIdx++; showQuestion(); }, 1200);
    }

    function endGame() {
        document.getElementById('quiz-area').classList.add('hidden');
        document.getElementById('end-screen').classList.remove('hidden');
        document.getElementById('final-score').innerText = score;

        const pNo = document.getElementById('player-no').value;
        const finalUrl = `${FORM_BASE_URL}/formResponse?${ID_NO}=${pNo}&${ID_SCORE}=${score}&submit=Submit`;
        
        const img = new Image();
        img.src = finalUrl;
        fetch(finalUrl, { mode: 'no-cors' }).catch(() => {});

        log("æˆç¸¾å·²é€å‡ºã€‚");
        setTimeout(loadRank, 2500); 
    }

    async function loadRank() {
        const content = document.getElementById('rank-content');
        try {
            const res = await fetch(`${RANK_CSV}&t=${Date.now()}`);
            if (!res.ok) throw new Error("Rank Fetch Fail");
            const text = await res.text();
            
            const lines = text.split(/\r?\n/).filter(line => line.trim() !== "");
            if (lines.length <= 1) {
                content.innerText = "ç›®å‰å°šç„¡æ’åç´€éŒ„ã€‚";
                return;
            }

            let data = lines.slice(1).map(line => {
                const c = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(item => item.replace(/^"|"$/g, '').trim());
                return { n: c[1] || "æœªçŸ¥", s: parseInt(c[2]) || 0 };
            }).filter(i => i.n !== "æœªçŸ¥");
            
            data.sort((a, b) => b.s - a.s);
            const uniqueData = [];
            const seen = new Set();
            for (const item of data) {
                if (!seen.has(item.n)) {
                    uniqueData.push(item);
                    seen.add(item.n);
                }
                if (uniqueData.length >= 5) break;
            }
            
            if (uniqueData.length > 0) {
                content.innerHTML = uniqueData.map((it, i) => `
                    <div class="rank-item">
                        <span class="rank-name">${i+1}. ${it.n} è™Ÿ</span>
                        <span class="rank-score">${it.s} åˆ†</span>
                    </div>`).join('');
            } else {
                content.innerText = "ç›®å‰å°šç„¡æœ‰æ•ˆç´€éŒ„";
            }
        } catch (e) { 
            content.innerHTML = `<span style="color:red;">æ’è¡Œæ¦œç²å–å¤±æ•—</span>`; 
        }
    }

    window.onload = loadData;
</script>
</body>
</html>
